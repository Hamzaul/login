{% extends "base.html" %}
{% block title %}Reset Password Â· Auth UI{% endblock %}

{% block content %}
<section class="card card-body">
  <h1>Reset Password</h1>
  <p class="muted">Enter your new password below.</p>

  <form id="resetForm" class="form">
    <input type="hidden" id="resetToken" value="{{ token }}">
    <label>New Password
      <input type="password" id="newPassword" placeholder="Enter new password" required />
    </label>
    <button type="submit" class="btn primary">Reset Password</button>
    <p id="resetMsg" class="msg"></p>
  </form>
</section>
{% endblock %}

{% block scripts %}
<script>
const resetForm = document.getElementById("resetForm");
const newPassword = document.getElementById("newPassword");
const resetMsg = document.getElementById("resetMsg");

function validatePassword(password) {
  // At least 8 chars, 1 uppercase, 1 lowercase, 1 number, 1 special char
  const re = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{8,}$/;
  return re.test(password);
}

resetForm.addEventListener("submit", async (e) => {
  e.preventDefault();
  const token = document.getElementById("resetToken").value;
  const password = newPassword.value.trim();

  if (!validatePassword(password)) {
    resetMsg.textContent = "Password must be at least 8 characters, include uppercase, lowercase, number, and special character.";
    resetMsg.style.color = "salmon";
    return;
  }

  try {
    const res = await fetch("/api/reset-password", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ token, password })
    });
    const data = await res.json();
    resetMsg.textContent = data.message || data.error;
    resetMsg.style.color = res.ok ? "lightgreen" : "salmon";

    if (res.ok) {
      setTimeout(() => {
        window.location.href = "/login";
      }, 2000);
    }
  } catch (err) {
    resetMsg.textContent = "Something went wrong.";
    resetMsg.style.color = "salmon";
  }
});
</script>
{% endblock %}
